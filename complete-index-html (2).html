<!DOCTYPE html>
<html>
<head>
    <title>Class 2</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .header h1 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .header p {
            color: #6c757d;
            font-size: 1.2rem;
            font-weight: 500;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .stat:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .stat-label {
            color: #6c757d;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9rem;
        }

        .card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .card h2 {
            color: #2d3748;
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .form-group {
            position: relative;
        }

        .form-group label {
            display: block;
            color: #4a5568;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            background: #ffffff;
            color: #2d3748;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-primary.btn-small {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(107, 114, 128, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
        }

        .info-box {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border: 1px solid #3b82f6;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            color: #1e40af;
            font-weight: 500;
        }

        .warning-box {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 1px solid #f59e0b;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            color: #92400e;
            font-weight: 500;
        }

        .demo-notice {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            color: #92400e;
            font-weight: 600;
            text-align: center;
        }

        .summary-overview {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            padding: 25px;
            border-radius: 15px;
            margin-top: 20px;
            border: 1px solid #0ea5e9;
        }

        .summary-overview h3 {
            color: #0c4a6e;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .summary-overview p {
            margin-bottom: 10px;
            color: #075985;
            font-weight: 500;
        }

        .summary-overview .highlight {
            color: #0c4a6e;
            font-size: 1.1rem;
            font-weight: 700;
        }

        .soldier-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            border: 1px solid #e2e8f0;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .soldier-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.12);
        }

        .soldier-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 25px;
            color: white;
        }

        .soldier-name {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 15px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .soldier-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }

        .soldier-stat {
            text-align: center;
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
        }

        .soldier-stat-number {
            font-size: 1.8rem;
            font-weight: 800;
            margin-bottom: 5px;
        }

        .soldier-stat-label {
            font-size: 0.85rem;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .contact-section {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .contact-info {
            color: #0c4a6e;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .equipment-details {
            padding: 25px;
        }

        .equipment-item {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            position: relative;
        }

        .equipment-item:hover {
            transform: translateX(5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .equipment-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 0 4px 4px 0;
        }

        .equipment-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .equipment-details-text {
            color: #64748b;
            margin-bottom: 12px;
            font-weight: 500;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .status-issued {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .status-returned {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .equipment-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .equipment-actions .btn {
            padding: 8px 16px;
            font-size: 0.85rem;
        }

        .no-equipment {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
            font-size: 1.2rem;
            font-weight: 500;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.85rem;
        }

        .soldier-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: 600;
            color: #1e293b;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .soldier-badge:hover {
            transform: translateY(-2px);
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }

        .soldier-badge .badge-name {
            font-weight: 700;
        }

        .soldier-badge .badge-count {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 700;
        }

        .soldier-badge:hover .badge-count {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .highlighted-soldier {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%) !important;
            border: 2px solid #f59e0b !important;
            transform: scale(1.02);
            box-shadow: 0 20px 40px rgba(245, 158, 11, 0.2) !important;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .btn {
                text-align: center;
            }
            
            .soldier-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .contact-section {
                flex-direction: column;
                text-align: center;
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card, .soldier-card {
            animation: fadeInUp 0.6s ease-out;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ–ï¸ Class 2</h1>
            <p>Advanced Equipment Management System for Reserve Units</p>
        </div>

        <div class="stats">
            <div class="stat">
                <div class="stat-number" id="totalSoldiers">0</div>
                <div class="stat-label">Total Soldiers</div>
            </div>
            <div class="stat">
                <div class="stat-number" id="totalEquipment">0</div>
                <div class="stat-label">Equipment Items</div>
            </div>
            <div class="stat">
                <div class="stat-number" id="issuedEquipment">0</div>
                <div class="stat-label">Currently Issued</div>
            </div>
            <div class="stat">
                <div class="stat-number" id="returnedEquipment">0</div>
                <div class="stat-label">Returned</div>
            </div>
        </div>

        <div class="card">
            <h2>â• Add Equipment Assignment</h2>
            
            <div class="info-box">
                <strong>ğŸ’¡ WhatsApp Integration</strong> - Fill in phone numbers to send WhatsApp messages to soldiers. Use Israeli format: 0501234567
            </div>

            <div id="multipleItemsNotice" class="warning-box" style="display: none;">
                <strong>âš¡ Quick Add Mode:</strong> Adding multiple items for <span id="currentSoldierName" style="font-weight: bold;"></span>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label>Soldier Name</label>
                    <input type="text" id="soldierName" placeholder="Enter soldier's full name">
                </div>
                
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="tel" id="soldierPhone" placeholder="0501234567" pattern="[0-9]*" maxlength="10">
                </div>
                
                <div class="form-group">
                    <label>Equipment Type</label>
                    <select id="equipmentType" onchange="updateEquipmentOptions()">
                        <option value="weapon">× ×©×§</option>
                        <option value="sight">×›×•×•× ×ª</option>
                        <option value="amrel">×××¨×œ</option>
                        <option value="grenade">×¨×™××•× ×™×</option>
                        <option value="custom">××—×¨</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Equipment Name</label>
                    <select id="equipmentName" style="display: block;">
                        <option value="">Select equipment...</option>
                    </select>
                    <input type="text" id="customEquipmentName" placeholder="Enter custom equipment name" style="display: none;">
                    
                    <!-- Grenade checkboxes -->
                    <div id="grenadeCheckboxes" style="display: none;">
                        <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; margin-top: 10px;">
                            <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9rem; text-transform: none;">
                                <input type="checkbox" value="1" onchange="updateGrenadeSelection()"> 1
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9rem; text-transform: none;">
                                <input type="checkbox" value="2" onchange="updateGrenadeSelection()"> 2
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9rem; text-transform: none;">
                                <input type="checkbox" value="3" onchange="updateGrenadeSelection()"> 3
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9rem; text-transform: none;">
                                <input type="checkbox" value="4" onchange="updateGrenadeSelection()"> 4
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9rem; text-transform: none;">
                                <input type="checkbox" value="5" onchange="updateGrenadeSelection()"> 5
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9rem; text-transform: none;">
                                <input type="checkbox" value="6" onchange="updateGrenadeSelection()"> 6
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9rem; text-transform: none;">
                                <input type="checkbox" value="7" onchange="updateGrenadeSelection()"> 7
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9rem; text-transform: none;">
                                <input type="checkbox" value="8" onchange="updateGrenadeSelection()"> 8
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9rem; text-transform: none;">
                                <input type="checkbox" value="9" onchange="updateGrenadeSelection()"> 9
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9rem; text-transform: none;">
                                <input type="checkbox" value="10" onchange="updateGrenadeSelection()"> 10
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9rem; text-transform: none;">
                                <input type="checkbox" value="11" onchange="updateGrenadeSelection()"> 11
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9rem; text-transform: none;">
                                <input type="checkbox" value="12" onchange="updateGrenadeSelection()"> 12
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9rem; text-transform: none;">
                                <input type="checkbox" value="13" onchange="updateGrenadeSelection()"> 13
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9rem; text-transform: none;">
                                <input type="checkbox" value="14" onchange="updateGrenadeSelection()"> 14
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9rem; text-transform: none;">
                                <input type="checkbox" value="15" onchange="updateGrenadeSelection()"> 15
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9rem; text-transform: none;">
                                <input type="checkbox" value="16" onchange="updateGrenadeSelection()"> 16
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9rem; text-transform: none;">
                                <input type="checkbox" value="17" onchange="updateGrenadeSelection()"> 17
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9rem; text-transform: none;">
                                <input type="checkbox" value="18" onchange="updateGrenadeSelection()"> 18
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9rem; text-transform: none;">
                                <input type="checkbox" value="19" onchange="updateGrenadeSelection()"> 19
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9rem; text-transform: none;">
                                <input type="checkbox" value="20" onchange="updateGrenadeSelection()"> 20
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9rem; text-transform: none;">
                                <input type="checkbox" value="21" onchange="updateGrenadeSelection()"> 21
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9rem; text-transform: none;">
                                <input type="checkbox" value="22" onchange="updateGrenadeSelection()"> 22
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9rem; text-transform: none;">
                                <input type="checkbox" value="23" onchange="updateGrenadeSelection()"> 23
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9rem; text-transform: none;">
                                <input type="checkbox" value="24" onchange="updateGrenadeSelection()"> 24
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9rem; text-transform: none;">
                                <input type="checkbox" value="25" onchange="updateGrenadeSelection()"> 25
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9rem; text-transform: none;">
                                <input type="checkbox" value="26" onchange="updateGrenadeSelection()"> 26
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9rem; text-transform: none;">
                                <input type="checkbox" value="27" onchange="updateGrenadeSelection()"> 27
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9rem; text-transform: none;">
                                <input type="checkbox" value="28" onchange="updateGrenadeSelection()"> 28
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9rem; text-transform: none;">
                                <input type="checkbox" value="29" onchange="updateGrenadeSelection()"> 29
                            </label>
                            <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9rem; text-transform: none;">
                                <input type="checkbox" value="30" onchange="updateGrenadeSelection()"> 30
                            </label>
                        </div>
                        <input type="text" id="selectedGrenades" readonly placeholder="Selected numbers will appear here" style="margin-top: 10px; background-color: #f8f9fa;">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Serial Number</label>
                    <input type="text" id="serialNumber" placeholder="Serial number (required)">
                </div>
                
                <div class="form-group">
                    <label>Status</label>
                    <select id="status">
                        <option value="issued">Issued</option>
                        <option value="returned">Returned</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="dateAssigned">
                </div>
            </div>
            
            <div class="button-group">
                <button class="btn btn-primary" onclick="addEquipment()">Add Equipment Assignment</button>
                <button class="btn btn-secondary" onclick="addAnother()" id="addAnotherBtn" style="display:none">Add Another for Same Soldier</button>
                <button class="btn btn-danger" onclick="clearForm()">Clear Form</button>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ“Š Total Equipment Summary</h2>
            <div class="stats">
                <div class="stat">
                    <div class="stat-number" id="totalWeapons">0</div>
                    <div class="stat-label">×¡×”"×› × ×©×§×™×</div>
                </div>
                <div class="stat">
                    <div class="stat-number" id="totalSights">0</div>
                    <div class="stat-label">×›×•×•× ×•×ª</div>
                </div>
                <div class="stat">
                    <div class="stat-number" id="totalAmrel">0</div>
                    <div class="stat-label">×××¨×œ</div>
                </div>
                <div class="stat">
                    <div class="stat-number" id="totalGrenades">0</div>
                    <div class="stat-label">×¨×™××•× ×™×</div>
                </div>
                <div class="stat">
                    <div class="stat-number" id="totalOther">0</div>
                    <div class="stat-label">××—×¨</div>
                </div>
            </div>
            
            <!-- Weapon Breakdown -->
            <div class="summary-overview">
                <h3>ğŸ”« ×¤×™×¨×•×˜ × ×©×§×™×</h3>
                <div class="stats">
                    <div class="stat">
                        <div class="stat-number" id="weaponM4">0</div>
                        <div class="stat-label">M4</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number" id="weaponNegev">0</div>
                        <div class="stat-label">× ×’×‘</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number" id="weaponNegevon">0</div>
                        <div class="stat-label">× ×’×‘×•×Ÿ</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number" id="weaponMatol">0</div>
                        <div class="stat-label">××˜×•×œ</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number" id="weaponKala">0</div>
                        <div class="stat-label">×§×œ×¢</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number" id="weaponMag">0</div>
                        <div class="stat-label">×××’</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ” Search & Filter</h2>
            <div class="form-grid">
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label>Quick Soldier Search</label>
                    <div id="soldierBar" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; padding: 15px; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 12px; border: 1px solid #e2e8f0; min-height: 60px;">
                        <div style="color: #64748b; font-style: italic; align-self: center;">No soldiers with equipment yet...</div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Search Equipment</label>
                    <input type="text" id="searchInput" placeholder="Search soldiers or equipment..." onkeyup="filterEquipment()">
                </div>
                <div class="form-group">
                    <label>Filter by Status</label>
                    <select id="filterStatus" onchange="filterEquipment()">
                        <option value="all">All Status</option>
                        <option value="issued">Issued Only</option>
                        <option value="returned">Returned Only</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ“ Import / Export Data</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label>Import CSV/Excel File</label>
                    <input type="file" id="importFile" accept=".csv,.xlsx,.xls" onchange="importData()" style="padding: 10px;">
                    <small style="color: #6c757d; margin-top: 5px; display: block;">Upload CSV or Excel file with columns: Soldier Name, Phone, Equipment Type, Equipment Name, Serial Number, Status, Date</small>
                </div>
                <div class="form-group">
                    <label>Export Data</label>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="exportToCSV()">ğŸ“¥ Export to CSV</button>
                        <button class="btn btn-secondary" onclick="exportToExcel()">ğŸ“Š Export to Excel</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ“‹ Equipment Assignments</h2>
            <div id="equipmentContainer">
                <div class="no-equipment">No equipment assignments yet. Add your first assignment above!</div>
            </div>
        </div>
    </div>

    <script>
        // Data storage
        let soldiers = {};
        
        // Initialize with only saved data - no demo data
        function initializeData() {
            const savedData = JSON.parse(localStorage.getItem('soldiers') || '{}');
            soldiers = savedData; // Only use saved data, no demo data
        }
        
        let lastSoldierInfo = null;
        
        // Equipment options by type
        const equipmentOptions = {
            weapon: [
                'M4',
                '× ×’×‘',
                '× ×’×‘×•×Ÿ',
                '××˜×•×œ',
                '×§×œ×¢',
                '×××’'
            ],
            sight: [
                'M5',
                '×˜×¨×™×’',
                '×œ×™××•×¨',
                '××˜×œ×•×Ÿ',
                '××§×™×œ×”'
            ],
            amrel: [
                '×©×—"×¢',
                '×©×—"×',
                '×¢×›×‘×¨',
                '××©×§×¤×ª',
                '××¦×¤×Ÿ',
                '××˜×œ×•×Ÿ',
                '×¤××§',
                '××›×¤×œ'
            ],
            grenade: [
                '1','2','3','4','5','6','7','8','9','10',
                '11','12','13','14','15','16','17','18','19','20',
                '21','22','23','24','25','26','27','28','29','30'
            ]
        };
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeData();
            document.getElementById('dateAssigned').value = new Date().toISOString().split('T')[0];
            updateEquipmentOptions();
            renderSoldiers();
            updateStats();
            updateSoldierBar();
        });
        
        // Update equipment dropdown based on type
        function updateEquipmentOptions() {
            const type = document.getElementById('equipmentType').value;
            const equipmentSelect = document.getElementById('equipmentName');
            const customInput = document.getElementById('customEquipmentName');
            const grenadeCheckboxes = document.getElementById('grenadeCheckboxes');
            
            // Hide all inputs first
            equipmentSelect.style.display = 'none';
            customInput.style.display = 'none';
            grenadeCheckboxes.style.display = 'none';
            
            if (type === 'custom') {
                customInput.style.display = 'block';
                customInput.value = '';
            } else if (type === 'grenade') {
                grenadeCheckboxes.style.display = 'block';
                // Clear all checkboxes
                const checkboxes = grenadeCheckboxes.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(cb => cb.checked = false);
                document.getElementById('selectedGrenades').value = '';
            } else {
                equipmentSelect.style.display = 'block';
                
                equipmentSelect.innerHTML = '<option value="">Select equipment...</option>';
                
                if (equipmentOptions[type]) {
                    equipmentOptions[type].forEach(option => {
                        const optEl = document.createElement('option');
                        optEl.value = option;
                        optEl.textContent = option;
                        equipmentSelect.appendChild(optEl);
                    });
                }
            }
        }
        
        // Handle grenade checkbox selections
        function updateGrenadeSelection() {
            const checkboxes = document.querySelectorAll('#grenadeCheckboxes input[type="checkbox"]:checked');
            const selected = Array.from(checkboxes).map(cb => cb.value).sort((a, b) => parseInt(a) - parseInt(b));
            document.getElementById('selectedGrenades').value = selected.join(', ');
        }
        
        // Fixed phone number formatting function
        function formatPhoneNumber(phoneNumber) {
            if (!phoneNumber) return null;
            
            // Remove all non-digit characters
            let cleanPhone = phoneNumber.toString().replace(/\D/g, '');
            
            console.log('Original phone:', phoneNumber);
            console.log('Clean phone:', cleanPhone);
            
            // Validate length (Israeli numbers should be 9-10 digits after cleaning)
            if (cleanPhone.length < 9 || cleanPhone.length > 10) {
                console.error('Invalid phone length:', cleanPhone.length);
                return null;
            }
            
            // Handle Israeli phone number formats
            if (cleanPhone.length === 10 && cleanPhone.startsWith('0')) {
                // Remove leading 0 and add country code
                cleanPhone = '972' + cleanPhone.substring(1);
            } else if (cleanPhone.length === 9 && !cleanPhone.startsWith('972')) {
                // Add country code for 9-digit numbers
                cleanPhone = '972' + cleanPhone;
            } else if (cleanPhone.length === 12 && cleanPhone.startsWith('972')) {
                // Already in international format - keep as is
            } else if (cleanPhone.length === 13 && cleanPhone.startsWith('0972')) {
                // Remove leading 0 from international format
                cleanPhone = cleanPhone.substring(1);
            } else {
                console.error('Unrecognized phone format:', cleanPhone);
                return null;
            }
            
            console.log('Formatted phone:', cleanPhone);
            
            // Final validation - should be 12 digits starting with 972
            if (cleanPhone.length !== 12 || !cleanPhone.startsWith('972')) {
                console.error('Final validation failed:', cleanPhone);
                return null;
            }
            
            return cleanPhone;
        }
        
        // Add equipment
        function addEquipment() {
            const soldierName = document.getElementById('soldierName').value.trim();
            const soldierPhone = document.getElementById('soldierPhone').value.trim();
            const equipmentType = document.getElementById('equipmentType').value;
            
            let equipmentName;
            if (equipmentType === 'custom') {
                equipmentName = document.getElementById('customEquipmentName').value.trim();
            } else if (equipmentType === 'grenade') {
                equipmentName = document.getElementById('selectedGrenades').value.trim();
                if (!equipmentName) {
                    alert('Please select at least one grenade number.');
                    return;
                }
            } else {
                equipmentName = document.getElementById('equipmentName').value;
            }
            
            const serialNumber = document.getElementById('serialNumber').value.trim();
            const status = document.getElementById('status').value;
            const dateAssigned = document.getElementById('dateAssigned').value;
            
            if (!soldierName || !equipmentName || !serialNumber) {
                alert('Please fill in soldier name, equipment name, and serial number.');
                return;
            }
            
            // Create soldier if doesn't exist
            if (!soldiers[soldierName]) {
                soldiers[soldierName] = {
                    phone: soldierPhone,
                    equipment: []
                };
            } else {
                // Update phone if provided and different
                if (soldierPhone && soldierPhone !== soldiers[soldierName].phone) {
                    soldiers[soldierName].phone = soldierPhone;
                }
            }
            
            // Add equipment
            soldiers[soldierName].equipment.push({
                id: Date.now() + Math.random(),
                type: equipmentType,
                name: equipmentName,
                serialNumber: serialNumber,
                status: status,
                dateAssigned: dateAssigned
            });
            
            // Save soldier info for quick add
            lastSoldierInfo = {
                name: soldierName,
                phone: soldierPhone
            };
            
            // Save and update
            saveSoldiers();
            renderSoldiers();
            updateStats();
            updateSoldierBar();
            
            // Clear equipment fields but keep soldier info
            document.getElementById('equipmentType').value = 'weapon';
            updateEquipmentOptions();
            document.getElementById('equipmentName').value = '';
            document.getElementById('customEquipmentName').value = '';
            document.getElementById('selectedGrenades').value = '';
            // Clear grenade checkboxes
            const grenadeCheckboxes = document.querySelectorAll('#grenadeCheckboxes input[type="checkbox"]');
            grenadeCheckboxes.forEach(cb => cb.checked = false);
            document.getElementById('serialNumber').value = '';
            document.getElementById('status').value = 'issued';
            
            // Show quick add option and update soldier bar
            document.getElementById('addAnotherBtn').style.display = 'inline-block';
            document.getElementById('multipleItemsNotice').style.display = 'block';
            document.getElementById('currentSoldierName').textContent = soldierName;
            
            // Make sure soldier bar updates
            setTimeout(() => updateSoldierBar(), 100);
        }
        
        // Quick add equipment for existing soldier
        function quickAddEquipment(soldierName) {
            document.getElementById('soldierName').value = soldierName;
            document.getElementById('soldierPhone').value = soldiers[soldierName].phone || '';
            
            document.getElementById('equipmentType').value = 'weapon';
            updateEquipmentOptions();
            document.getElementById('equipmentName').value = '';
            document.getElementById('customEquipmentName').value = '';
            document.getElementById('serialNumber').value = '';
            document.getElementById('status').value = 'issued';
            document.getElementById('dateAssigned').value = new Date().toISOString().split('T')[0];
            
            document.getElementById('addAnotherBtn').style.display = 'inline-block';
            document.getElementById('multipleItemsNotice').style.display = 'block';
            document.getElementById('currentSoldierName').textContent = soldierName;
            
            document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
            document.getElementById('serialNumber').focus();
        }
        
        // Add another item for same soldier
        function addAnother() {
            document.getElementById('equipmentType').value = 'weapon';
            updateEquipmentOptions();
            document.getElementById('equipmentName').value = '';
            document.getElementById('customEquipmentName').value = '';
            document.getElementById('selectedGrenades').value = '';
            // Clear grenade checkboxes
            const grenadeCheckboxes = document.querySelectorAll('#grenadeCheckboxes input[type="checkbox"]');
            grenadeCheckboxes.forEach(cb => cb.checked = false);
            document.getElementById('serialNumber').value = '';
            document.getElementById('status').value = 'issued';
            document.getElementById('serialNumber').focus();
        }
        
        // Clear form
        function clearForm() {
            document.getElementById('soldierName').value = '';
            document.getElementById('soldierPhone').value = '';
            document.getElementById('equipmentType').value = 'weapon';
            updateEquipmentOptions();
            document.getElementById('equipmentName').value = '';
            document.getElementById('customEquipmentName').value = '';
            document.getElementById('selectedGrenades').value = '';
            // Clear grenade checkboxes
            const grenadeCheckboxes = document.querySelectorAll('#grenadeCheckboxes input[type="checkbox"]');
            grenadeCheckboxes.forEach(cb => cb.checked = false);
            document.getElementById('serialNumber').value = '';
            document.getElementById('status').value = 'issued';
            document.getElementById('dateAssigned').value = new Date().toISOString().split('T')[0];
            
            document.getElementById('addAnotherBtn').style.display = 'none';
            document.getElementById('multipleItemsNotice').style.display = 'none';
            lastSoldierInfo = null;
        }
        
        // Edit phone number
        function editPhone(soldierName) {
            const currentPhone = soldiers[soldierName].phone || '';
            const newPhone = prompt(`×”×–×Ÿ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×¢×‘×•×¨ ${soldierName} (×¤×•×¨××˜: 0501234567):`, currentPhone);
            if (newPhone !== null) {
                soldiers[soldierName].phone = newPhone.trim();
                saveSoldiers();
                renderSoldiers();
                updateSoldierBar();
            }
        }
        
        // Send WhatsApp for specific item
        function sendWhatsAppForItem(soldierName, equipmentId) {
            const soldier = soldiers[soldierName];
            const equipment = soldier.equipment.find(e => e.id === equipmentId);
            if (equipment) {
                sendWhatsApp(soldierName, equipment);
            }
        }
        
        // Fixed WhatsApp function
        function sendWhatsApp(soldierName, equipment = null) {
            const soldier = soldiers[soldierName];
            
            if (!soldier.phone || soldier.phone.trim() === '') {
                alert('××™×Ÿ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×œ×—×™×™×œ ×–×”. ×™×© ×œ×”×•×¡×™×£ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×‘×¤×•×¨××˜: 0501234567');
                return;
            }
            
            // Format phone number
            const formattedPhone = formatPhoneNumber(soldier.phone);
            
            if (!formattedPhone) {
                alert('××¡×¤×¨ ×˜×œ×¤×•×Ÿ ×œ× ×ª×§×™×Ÿ. ×™×© ×œ×”×–×™×Ÿ ××¡×¤×¨ ×‘×¤×•×¨××˜: 0501234567\n\n××¡×¤×¨ × ×•×›×—×™: ' + soldier.phone);
                return;
            }
            
            let message = '';
            if (equipment) {
                // Message for specific equipment
                const typeLabel = equipment.type === 'weapon' ? '× ×©×§' : 
                                 equipment.type === 'sight' ? '×›×•×•× ×ª' : 
                                 equipment.type === 'amrel' ? '×××¨×œ' :
                                 equipment.type === 'grenade' ? '×¨×™××•×Ÿ' :
                                 equipment.type === 'custom' ? '××—×¨' :
                                 equipment.type.charAt(0).toUpperCase() + equipment.type.slice(1);
                message = `×©×œ×•× ${soldierName},\n\n×–×•×”×™ ×ª×–×›×•×¨×ª ×©×™×© ×‘×¨×©×•×ª×š:\n${typeLabel}: ${equipment.name}\n××¡×¤×¨ ×¡×™×“×•×¨×™: ${equipment.serialNumber}\n×ª××¨×™×š ×§×‘×œ×”: ${equipment.dateAssigned}\n\n×‘×‘×§×©×” ×œ×‘×“×•×§ ×©×›×œ ×”×¦×™×•×“ ××›×Ÿ ××¦×œ×š ×œ×¤×™ ×”××¡×¤×¨ ×”×¨×œ×•×•× ×˜×™.\n×ª×•×“×”, ××—×œ×§×” 2.`;
            } else {
                // General message for all equipment
                const issuedItems = soldier.equipment.filter(e => e.status === 'issued');
                if (issuedItems.length === 0) {
                    alert('××™×Ÿ ×¦×™×•×“ ×œ×”×—×–×¨×”');
                    return;
                }
                message = `×©×œ×•× ${soldierName},\n\n×™×© ×œ×š ${issuedItems.length} ×¤×¨×™×˜×™ ×¦×™×•×“ ×œ×”×—×–×™×¨:\n\n`;
                issuedItems.forEach(item => {
                    const typeLabel = item.type === 'weapon' ? '× ×©×§' : 
                                     item.type === 'sight' ? '×›×•×•× ×ª' : 
                                     item.type === 'amrel' ? '×××¨×œ' :
                                     item.type === 'grenade' ? '×¨×™××•×Ÿ' :
                                     item.type === 'custom' ? '××—×¨' :
                                     item.type.charAt(0).toUpperCase() + item.type.slice(1);
                    message += `â€¢ ${typeLabel}: ${item.name} (${item.serialNumber})\n`;
                });
                message += `\n×‘×‘×§×©×” ×œ×‘×“×•×§ ×©×›×œ ×”×¦×™×•×“ ××›×Ÿ ××¦×œ×š ×œ×¤×™ ×”××¡×¤×¨ ×”×¨×œ×•×•× ×˜×™.\n×ª×•×“×”, ××—×œ×§×” 2.`;
            }
            
            // Encode message for URL
            const encodedMessage = encodeURIComponent(message);
            
            console.log('Sending WhatsApp to phone:', formattedPhone);
            console.log('Original phone input:', soldier.phone);
            
            // Open WhatsApp
            const whatsappUrl = `https://wa.me/${formattedPhone}?text=${encodedMessage}`;
            window.open(whatsappUrl, '_blank');
        }
        
        // Delete soldier
        function deleteSoldier(soldierName) {
            if (confirm(`Are you sure you want to delete ${soldierName} and all their equipment records?`)) {
                delete soldiers[soldierName];
                saveSoldiers();
                renderSoldiers();
                updateStats();
                updateSoldierBar();
            }
        }
        
        // Delete equipment item
        function deleteEquipment(soldierName, equipmentId) {
            if (confirm('Are you sure you want to delete this equipment item?')) {
                soldiers[soldierName].equipment = soldiers[soldierName].equipment.filter(e => e.id !== equipmentId);
                
                if (soldiers[soldierName].equipment.length === 0) {
                    if (confirm(`${soldierName} has no equipment left. Delete soldier record?`)) {
                        delete soldiers[soldierName];
                    }
                }
                
                saveSoldiers();
                renderSoldiers();
                updateStats();
                updateSoldierBar();
            }
        }
        
        // Toggle equipment status
        function toggleStatus(soldierName, equipmentId) {
            const equipment = soldiers[soldierName].equipment.find(e => e.id === equipmentId);
            if (equipment) {
                equipment.status = equipment.status === 'issued' ? 'returned' : 'issued';
                saveSoldiers();
                renderSoldiers();
                updateStats();
                updateSoldierBar();
            }
        }
        
        // Render soldiers
        function renderSoldiers() {
            const container = document.getElementById('equipmentContainer');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filterStatus = document.getElementById('filterStatus').value;
            
            // Update soldier bar every time we render
            updateSoldierBar();
            
            if (Object.keys(soldiers).length === 0) {
                container.innerHTML = '<div class="no-equipment">No equipment assignments yet. Add your first assignment above!</div>';
                return;
            }
            
            let html = '';
            
            for (const [soldierName, soldierData] of Object.entries(soldiers)) {
                // Filter by search
                const matchesSearch = soldierName.toLowerCase().includes(searchTerm) || 
                    soldierData.equipment.some(e => 
                        e.name.toLowerCase().includes(searchTerm) ||
                        e.serialNumber.toLowerCase().includes(searchTerm)
                    );
                
                if (!matchesSearch) continue;
                
                // Filter equipment by status
                const filteredEquipment = filterStatus === 'all' 
                    ? soldierData.equipment 
                    : soldierData.equipment.filter(e => e.status === filterStatus);
                
                if (filterStatus !== 'all' && filteredEquipment.length === 0) continue;
                
                // Calculate stats
                const totalItems = soldierData.equipment.length;
                const issuedItems = soldierData.equipment.filter(e => e.status === 'issued').length;
                const returnedItems = totalItems - issuedItems;
                
                html += `
                    <div class="soldier-card" id="soldier-${soldierName.replace(/[^a-zA-Z0-9]/g, '')}">
                        <div class="soldier-header">
                            <div class="soldier-name">${soldierName}</div>
                            <div class="soldier-stats">
                                <div class="soldier-stat">
                                    <div class="soldier-stat-number">${totalItems}</div>
                                    <div class="soldier-stat-label">Total</div>
                                </div>
                                <div class="soldier-stat">
                                    <div class="soldier-stat-number">${issuedItems}</div>
                                    <div class="soldier-stat-label">Issued</div>
                                </div>
                                <div class="soldier-stat">
                                    <div class="soldier-stat-number">${returnedItems}</div>
                                    <div class="soldier-stat-label">Returned</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="contact-section">
                            <div class="contact-info">
                                ğŸ“± ${soldierData.phone ? `${soldierData.phone}` : '×œ× ×”×•×–×Ÿ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ'}
                            </div>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="btn btn-primary btn-small" onclick="quickAddEquipment('${soldierName.replace(/'/g, "\\'")}')">â• Add Equipment</button>
                                ${soldierData.phone ? `<button class="btn btn-primary btn-small" onclick="sendWhatsApp('${soldierName.replace(/'/g, "\\'")}')">ğŸ’¬ WhatsApp</button>` : ''}
                                <button class="btn btn-secondary btn-small" onclick="editPhone('${soldierName.replace(/'/g, "\\'")}')">ğŸ“± ${soldierData.phone ? 'Edit' : 'Add'} Phone</button>
                                <button class="btn btn-danger btn-small" onclick="deleteSoldier('${soldierName.replace(/'/g, "\\'")}')">Delete Soldier</button>
                            </div>
                        </div>
                        
                        <div class="equipment-details">
                `;
                
                // Show filtered equipment
                const equipmentToShow = filterStatus === 'all' ? soldierData.equipment : filteredEquipment;
                
                for (const equipment of equipmentToShow) {
                    const typeLabel = equipment.type === 'weapon' ? '× ×©×§' : 
                                     equipment.type === 'sight' ? '×›×•×•× ×ª' : 
                                     equipment.type === 'amrel' ? '×××¨×œ' :
                                     equipment.type === 'grenade' ? '×¨×™××•×Ÿ' :
                                     equipment.type === 'custom' ? '××—×¨' :
                                     equipment.type.charAt(0).toUpperCase() + equipment.type.slice(1);
                    
                    html += `
                        <div class="equipment-item">
                            <div class="equipment-name">${typeLabel}: ${equipment.name}</div>
                            <div class="equipment-details-text">Serial Number: ${equipment.serialNumber} | Date: ${equipment.dateAssigned}</div>
                            <div class="status-badge ${equipment.status === 'issued' ? 'status-issued' : 'status-returned'}">
                                ${equipment.status === 'issued' ? 'âœ“ Issued' : 'âœ— Returned'}
                            </div>
                            <div class="equipment-actions">
                                <button class="btn btn-secondary btn-small" onclick="toggleStatus('${soldierName.replace(/'/g, "\\'")}', ${equipment.id})">
                                    Mark as ${equipment.status === 'issued' ? 'Returned' : 'Issued'}
                                </button>
                                <button class="btn btn-danger btn-small" onclick="deleteEquipment('${soldierName.replace(/'/g, "\\'")}', ${equipment.id})">Delete Item</button>
                                ${soldierData.phone && equipment.status === 'issued' ? `<button class="btn btn-warning btn-small" onclick='sendWhatsAppForItem("${soldierName.replace(/'/g, "\\'")}", ${equipment.id})'>ğŸ’¬ Send Reminder</button>` : ''}
                            </div>
                        </div>
                    `;
                }
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html || '<div class="no-equipment">No matching results found.</div>';
        }
        
        // Update statistics
        function updateStats() {
            let totalSoldiers = Object.keys(soldiers).length;
            let totalEquipment = 0;
            let issuedEquipment = 0;
            let returnedEquipment = 0;
            let typeCount = {};
            let weaponBreakdown = {};
            
            for (const soldierData of Object.values(soldiers)) {
                for (const equipment of soldierData.equipment) {
                    totalEquipment++;
                    
                    if (equipment.status === 'issued') {
                        issuedEquipment++;
                    } else {
                        returnedEquipment++;
                    }
                    
                    // Count by type
                    typeCount[equipment.type] = (typeCount[equipment.type] || 0) + 1;
                    
                    // Count weapon breakdown
                    if (equipment.type === 'weapon') {
                        weaponBreakdown[equipment.name] = (weaponBreakdown[equipment.name] || 0) + 1;
                    }
                }
            }
            
            // Update main stats
            document.getElementById('totalSoldiers').textContent = totalSoldiers;
            document.getElementById('totalEquipment').textContent = totalEquipment;
            document.getElementById('issuedEquipment').textContent = issuedEquipment;
            document.getElementById('returnedEquipment').textContent = returnedEquipment;
            
            // Update type stats
            document.getElementById('totalWeapons').textContent = typeCount.weapon || 0;
            document.getElementById('totalSights').textContent = typeCount.sight || 0;
            document.getElementById('totalAmrel').textContent = typeCount.amrel || 0;
            document.getElementById('totalGrenades').textContent = typeCount.grenade || 0;
            document.getElementById('totalOther').textContent = typeCount.custom || 0;
            
            // Update weapon breakdown
            document.getElementById('weaponM4').textContent = weaponBreakdown['M4'] || 0;
            document.getElementById('weaponNegev').textContent = weaponBreakdown['× ×’×‘'] || 0;
            document.getElementById('weaponNegevon').textContent = weaponBreakdown['× ×’×‘×•×Ÿ'] || 0;
            document.getElementById('weaponMatol').textContent = weaponBreakdown['××˜×•×œ'] || 0;
            document.getElementById('weaponKala').textContent = weaponBreakdown['×§×œ×¢'] || 0;
            document.getElementById('weaponMag').textContent = weaponBreakdown['×××’'] || 0;
        }
        
        // Update soldier bar
        function updateSoldierBar() {
            const soldierBar = document.getElementById('soldierBar');
            if (!soldierBar) {
                console.error('Soldier bar not found');
                return;
            }
            
            const soldiersWithEquipment = Object.entries(soldiers).filter(([name, data]) => data.equipment.length > 0);
            
            console.log('Updating soldier bar. Soldiers with equipment:', soldiersWithEquipment.length);
            
            if (soldiersWithEquipment.length === 0) {
                soldierBar.innerHTML = '<div style="color: #64748b; font-style: italic; align-self: center;">No soldiers with equipment yet...</div>';
                return;
            }
            
            let barHTML = '';
            soldiersWithEquipment.forEach(([soldierName, soldierData]) => {
                const totalItems = soldierData.equipment.length;
                
                barHTML += `
                    <div class="soldier-badge" onclick="selectSoldier('${soldierName.replace(/'/g, "\\'")}')">
                        <span class="badge-name">${soldierName}</span>
                        <span class="badge-count">${totalItems}</span>
                    </div>
                `;
            });
            
            soldierBar.innerHTML = barHTML;
            console.log('Soldier bar updated with HTML:', barHTML.substring(0, 100) + '...');
        }
        
        function selectSoldier(soldierName) {
            // Clear any existing highlights
            const existingHighlighted = document.querySelector('.highlighted-soldier');
            if (existingHighlighted) {
                existingHighlighted.classList.remove('highlighted-soldier');
            }
            
            // Find and highlight the soldier card
            const soldierCard = document.getElementById(`soldier-${soldierName.replace(/[^a-zA-Z0-9]/g, '')}`);
            if (soldierCard) {
                // Highlight the card
                soldierCard.classList.add('highlighted-soldier');
                
                // Scroll to the card
                soldierCard.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
                
                // Remove highlight after 3 seconds
                setTimeout(() => {
                    soldierCard.classList.remove('highlighted-soldier');
                }, 3000);
            }
        }
        
        // Filter equipment
        function filterEquipment() {
            renderSoldiers();
        }
        
        // Export to CSV
        function exportToCSV() {
            let csvContent = 'Soldier Name,Phone Number,Equipment Type,Equipment Name,Serial Number,Status,Date Assigned\n';
            
            for (const [soldierName, soldierData] of Object.entries(soldiers)) {
                for (const equipment of soldierData.equipment) {
                    const typeLabel = equipment.type === 'weapon' ? '× ×©×§' : 
                                     equipment.type === 'sight' ? '×›×•×•× ×ª' : 
                                     equipment.type === 'amrel' ? '×××¨×œ' :
                                     equipment.type === 'grenade' ? '×¨×™××•×Ÿ' :
                                     equipment.type === 'custom' ? '××—×¨' :
                                     equipment.type;
                    
                    csvContent += `"${soldierName}","${soldierData.phone || ''}","${typeLabel}","${equipment.name}","${equipment.serialNumber}","${equipment.status}","${equipment.dateAssigned}"\n`;
                }
            }
            
            // Create and download the file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `Class2_Equipment_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Export to Excel (proper Excel format with Hebrew support)
        function exportToExcel() {
            // Create proper Excel-compatible CSV with UTF-8 BOM
            const BOM = '\uFEFF';
            let csvContent = BOM + 'Soldier Name,Phone Number,Equipment Type,Equipment Name,Serial Number,Status,Date Assigned\r\n';
            
            for (const [soldierName, soldierData] of Object.entries(soldiers)) {
                for (const equipment of soldierData.equipment) {
                    const typeLabel = equipment.type === 'weapon' ? '× ×©×§' : 
                                     equipment.type === 'sight' ? '×›×•×•× ×ª' : 
                                     equipment.type === 'amrel' ? '×××¨×œ' :
                                     equipment.type === 'grenade' ? '×¨×™××•×Ÿ' :
                                     equipment.type === 'custom' ? '××—×¨' :
                                     equipment.type;
                    
                    // Escape quotes and ensure proper CSV formatting
                    const escapeCsv = (str) => {
                        if (str == null) return '';
                        const stringified = String(str);
                        // If contains comma, quote, or newline, wrap in quotes and escape internal quotes
                        if (stringified.includes(',') || stringified.includes('"') || stringified.includes('\n') || stringified.includes('\r')) {
                            return `"${stringified.replace(/"/g, '""')}"`;
                        }
                        return stringified;
                    };
                    
                    csvContent += `${escapeCsv(soldierName)},${escapeCsv(soldierData.phone || '')},${escapeCsv(typeLabel)},${escapeCsv(equipment.name)},${escapeCsv(equipment.serialNumber)},${escapeCsv(equipment.status)},${escapeCsv(equipment.dateAssigned)}\r\n`;
                }
            }
            
            // Create blob with explicit UTF-8 encoding for Excel
            const blob = new Blob([csvContent], { 
                type: 'application/vnd.ms-excel;charset=utf-8;' 
            });
            
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `Class2_Equipment_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
        
        // Enhanced import data function for better Android compatibility
        function importData() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a file to import.');
                return;
            }
            
            // Show loading message
            const originalText = fileInput.nextElementSibling.textContent;
            fileInput.nextElementSibling.textContent = 'Importing... Please wait.';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    let text = e.target.result;
                    
                    // Remove BOM if present (helps with Android)
                    if (text.charCodeAt(0) === 0xFEFF) {
                        text = text.slice(1);
                    }
                    
                    // Split lines and handle different line endings
                    const lines = text.split(/\r?\n/);
                    let importCount = 0;
                    
                    // Skip header row and process data
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        try {
                            // Parse CSV line with better error handling
                            const fields = parseCSVLine(line);
                            
                            if (fields.length >= 6) { // Minimum required fields
                                const [soldierName, phone, equipmentType, equipmentName, serialNumber, status, dateAssigned] = fields;
                                
                                // Skip empty soldier names
                                if (!soldierName || soldierName.trim() === '') continue;
                                
                                // Convert type labels back to internal format
                                let internalType = equipmentType.toLowerCase();
                                if (equipmentType === '× ×©×§' || equipmentType.includes('weapon')) internalType = 'weapon';
                                else if (equipmentType === '×›×•×•× ×ª' || equipmentType.includes('sight')) internalType = 'sight';
                                else if (equipmentType === '×××¨×œ' || equipmentType.includes('amrel')) internalType = 'amrel';
                                else if (equipmentType === '×¨×™××•×Ÿ' || equipmentType.includes('grenade')) internalType = 'grenade';
                                else if (equipmentType === '××—×¨' || equipmentType.includes('custom')) internalType = 'custom';
                                else internalType = 'custom'; // Default fallback
                                
                                // Create soldier if doesn't exist
                                if (!soldiers[soldierName.trim()]) {
                                    soldiers[soldierName.trim()] = {
                                        phone: phone ? phone.trim() : '',
                                        equipment: []
                                    };
                                }
                                
                                // Add equipment with validation
                                if (equipmentName && equipmentName.trim() && serialNumber && serialNumber.trim()) {
                                    soldiers[soldierName.trim()].equipment.push({
                                        id: Date.now() + Math.random() + i, // Unique ID
                                        type: internalType,
                                        name: equipmentName.trim(),
                                        serialNumber: serialNumber.trim(),
                                        status: status && status.toLowerCase().includes('return') ? 'returned' : 'issued',
                                        dateAssigned: dateAssigned || new Date().toISOString().split('T')[0]
                                    });
                                    importCount++;
                                }
                            }
                        } catch (lineError) {
                            console.warn('Error parsing line:', line, lineError);
                            // Continue with next line instead of failing completely
                        }
                    }
                    
                    // Save and refresh
                    saveSoldiers();
                    renderSoldiers();
                    updateStats();
                    updateSoldierBar();
                    
                    // Success message
                    alert(`Import completed! Successfully imported ${importCount} equipment items.`);
                    fileInput.value = ''; // Clear the file input
                    
                } catch (error) {
                    console.error('Import error:', error);
                    alert('Error importing file. Please check the file format. Make sure it\'s a CSV file exported from this system.');
                } finally {
                    // Restore original text
                    fileInput.nextElementSibling.textContent = originalText;
                }
            };
            
            reader.onerror = function() {
                alert('Error reading file. Please try again.');
                fileInput.nextElementSibling.textContent = originalText;
            };
            
            // Read as text with UTF-8 encoding
            reader.readAsText(file, 'UTF-8');
        }
        
        // Enhanced CSV parsing function for better compatibility
        function parseCSVLine(line) {
            const fields = [];
            let current = '';
            let inQuotes = false;
            let i = 0;
            
            while (i < line.length) {
                const char = line[i];
                const nextChar = line[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        // Escaped quote
                        current += '"';
                        i += 2;
                    } else {
                        // Toggle quote state
                        inQuotes = !inQuotes;
                        i++;
                    }
                } else if (char === ',' && !inQuotes) {
                    // Field separator
                    fields.push(current.trim());
                    current = '';
                    i++;
                } else {
                    // Regular character
                    current += char;
                    i++;
                }
            }
            
            // Add the last field
            fields.push(current.trim());
            
            // Clean up fields (remove extra quotes)
            return fields.map(field => {
                // Remove surrounding quotes if present
                if (field.startsWith('"') && field.endsWith('"')) {
                    return field.slice(1, -1);
                }
                return field;
            });
        }
        
        // Save to localStorage 
        function saveSoldiers() {
            localStorage.setItem('soldiers', JSON.stringify(soldiers));
        }
    </script>
</body>
</html>